.. SPDX-License-Identifier: GPL-2.0-only


高通云AI 100 (AIC100)
=====================

概述
====

高通云AI 100/AIC100系列产品系列（包括SA9000P - 属于  
Snapdragon Ride平台）是包含专用 SoC ASIC 的 PCIe 适配卡，用于  
高效运行人工智能（AI）深度学习的目的  
推理工作负载。它们是AI加速器。
AIC100 的 PCIe 接口能够在八条通道上实现 PCIe Gen4 速度  
(x8)。一张卡上的单个SoC最多可拥有16个NSP用于运行工作负载。  
每个SoC都有一个A53管理CPU。在板卡上，最多可支持32 GB的DDR。  
单个系统可容纳多块AIC100卡以扩展整体性能  
性能。AIC100 卡支持多用户，能够执行工作负载  
以并发方式来自多个用户。
硬件描述
一块AIC100卡由一颗AIC100 SoC、板载DDR以及一组辅助组件构成  
外设（PMIC等）。

一张AIC100卡可以是PCIe HHHL外形规格（一种传统的PCIe卡），  
或双M.2卡。两者均通过PCIe连接到主机系统。
作为PCIe端点/适配器，AIC100使用标准的厂商ID（VID）/  
DeviceID（DID）组合，用于向主机唯一标识自身。AIC100  
使用标准的高通VID（0x17cb）。所有AIC100 SKU均使用相同的  
AIC100 DID (0xa100)。
AIC100 未实现 FLR（函数级重置）。

AIC100 实现了 MSI，但未实现 MSI-X。AIC100 更倾向于使用 17 个 MSI  
操作（MHI 为 1，DMA 桥接器为 16）。在可能的情况下，回退到 1 个 MSI  
在无法预留 32 个 MSI 的场景中。
作为PCIe设备，AIC100利用BAR为设备提供主机接口  
硬件。AIC100 提供 3 个 64 位 BAR。
* 第一个BAR大小为4K，向主机暴露MHI接口。

* 第二个BAR大小为2M，向DMA桥接接口暴露  
主机。
===============================================

* 第三个 BAR 的大小根据单个 AIC100 而变化  
配置，但默认为64K。此BAR目前无用途。
从主机的角度来看，AIC100 具有以下几个关键硬件组件 -  
* MHI（调制解调器主机接口）  
* QSM（QAIC 服务管理器）  
* NSPs（神经信号处理器）  
* DMA 桥接器  
* DDR

MHI
AIC100 通过 PCIe 提供一个 MHI 接口。MHI 本身的文档位于  
Documentation/mhi/index.rst MHI 是主机用于通信的机制  
与QSM配合使用。除了通过DMA桥接器获取工作负载数据外，所有与  
设备通过MHI发生。

QSM
QAIC 服务管理器。这是一个运行主控的 ARM A53 CPU  
卡的固件并执行卡上管理任务。它还  
通过MHI与主机通信。每个AIC100都具有其中之一  
这些。
NSP
神经信号处理器。每个AIC100最多包含16个此类处理器。这些是  
在AIC100上运行工作负载的处理器。每个NSP都是一个高通Hexagon  
(Q6) 带有HVX和HMX的DSP。每个NSP一次只能运行一个工作负载，但  
可以为单个工作负载分配多个NSP。由于每个NSP只能运行  
一个工作负载，AIC100 仅限于 16 个并发工作负载。工作负载  
"scheduling" 由主机负责。AIC100 不会自动  
timeslice.

DMA桥接器

DMA桥是一种自定义的DMA引擎，用于管理数据流  
在工作负载中进出。AIC100 拥有其中一个。DMA 桥接器具有 16 个  
通道，每个通道由一组请求/响应FIFO组成。每个活动  
工作负载被分配到单个DMA桥接通道。DMA桥接暴露  
用于管理FIFO的硬件寄存器（头/尾指针），但需要主机  
用于存储FIFO的内存。
双倍数据速率
AIC100 配备了板载 DDR。一个 AIC100 最多可拥有 32 GB 的 DDR。  
此DDR用于存储工作负载、工作负载的数据，并被用于  
用于管理设备的 QSM。NSP 被授予对 DDR 某些部分的访问权限  
QSM。主机无法直接访问DDR，必须进行  
向QSM发出请求，将数据传输到DDR。

高级使用流程
AIC100 是一种多用户、可编程加速器，通常用于运行  
以推理模式运行的神经网络，可高效执行人工智能操作。  
AIC100 不用于训练神经网络。AIC100 可被利用  
用于通用计算工作负载。

假设用户想要使用AIC100，他们将遵循以下步骤：  
1. 将工作负载编译为针对 NSP 的 ELF 文件  
2. 向QSM发送请求以将工作负载及相关工件加载到  
设备 DDR  
3. 向QSM发送请求，将工作负载激活到一组空闲的NSP上  
4. 向DMA桥接器发送请求，将输入数据发送到工作负载以进行处理  
已处理，以及其他请求从已处理的输出数据中接收数据的请求  
工作负载。  
5. 当工作负载不再需要时，向 QSM 发出请求以  
停用工作负载，从而使NSP恢复到空闲状态。  
6. 一旦工作负载及相关制品不再需要用于将来用途  
会话，向QSM发送请求以从DDR卸载数据。这将释放  
供其他用户使用的DDR。

启动流程
AIC100 采用无闪存启动流程，源自高通 MSM。  
当AIC100首次上电时，它开始执行PBL（主引导加载程序）  
来自ROM。PBL枚举PCIe链路，并初始化BHI（Boot Host  
MHI的接口组件。  
使用 BHI，主机将 PBL 指向 SBL（二级引导加载程序）的位置  
image。PBL 从主机拉取镜像，验证其有效性，并开始  
SBL的执行。  
SBL 初始化 MHI，并使用 MHI 通知主机设备已进入  
SBL 阶段。SBL 执行多项操作：  
* SBL 初始化大部分硬件（PBL 未初始化的任何部分），  
包括DDR。  
* SBL 将启动日志卸载到主机。  
* SBL 与主机同步时间戳，用于未来的日志记录。  
* SBL 使用 Sahara 协议从运行时获取固件镜像  
主机。  
一旦SBL获取并验证了运行时固件，它就会启动NSP  
复位，并跳转到QSM。  
QSM 使用 MHI 通知主机设备已进入 QSM 阶段  
（MHI术语中的AMSS）。此时，AIC100设备已完全具备功能，且  
准备好处理工作负载。

用户空间组件
编译器

基于上游LLVM的AIC100开源编译器可以在以下位置找到：  
https://github.com/quic/software-kit-for-qualcomm-cloud-ai-100-cc

用户模式驱动程序 (UMD)
一个与 qaic 内核驱动程序交互的开源 UMD 可在以下位置找到：  
https://github.com/quic/software-kit-for-qualcomm-cloud-ai-100
Sahara 加载器
一个名为 kickstart 的 Sahara 协议开源实现可以在以下位置找到：  
https://github.com/andersson/qdl
MHI 频道

AIC100 定义了多种用于不同目的的 MHI 通道。以下是列表  
已定义的通道及其用途。
-----------------------------------------------------------------------------

| 频道名称       | IDs     | EEs      | 用途                                     |
| QAIC_LOOPBACK  | 0 & 1   | AMSS     | 发送到该设备的任何数据                   |
|                |         |          | 通道被发送回主机。                       |
| QAIC_SAHARA    | 2 & 3   | SBL      | SBL 用于获取运行时的值                   |
|                |         |          | 从主机获取固件。                         |
| QAIC_DIAG      | 4 & 5   | AMSS     | 用于通过 QSM 进行通信的                  |
|                |         |          | DIAG 协议。                              |
| QAIC_SSR       | 6 & 7   | AMSS     | 用于通知主机子系统状态                   |
|                |         |          | 重启事件，并卸载SSR                      |
|                |         |          | crashdumps。                             |
| QAIC_QDSS      | 8 & 9   | AMSS     | 用于高通调试子系统。                     |
| QAIC_CONTROL   | 10 & 11 | AMSS     | 用于神经网络控制                         |
|                |         |          | (NNC) 协议。这是主要的                   |
|                |         |          | 主机与QSM之间的通道用于                  |
|                |         |          | 管理工作负载。                           |
| QAIC_LOGGING   | 12 & 13 | SBL      | SBL 用于将启动日志发送到                 |
|                |         |          | 主机。                                   |
| QAIC_STATUS    | 14 & 15 | AMSS     | 用于向主机通知可靠性，                   |
|                |         |          | 可访问性、可服务性 (RAS)                 |
|                |         |          | events。                                 |
| QAIC_TELEMETRY | 16 & 17 | AMSS     | 用于获取/设置电源、温度等信息            |
|                |         |          | attributes。                             |
| QAIC_DEBUG     | 18 & 19 | AMSS     | 未使用。                                  |
| QAIC_TIMESYNC  | 20 & 21 | SBL      | 用于同步时间戳                           |
|                |         |          | 设备端日志与主机时间                     |
|                |         |          | source。                                 |
| QAIC_TIMESYNC  | 22 & 23 | AMSS     | 用于周期性同步                           |
| _PERIODIC      |         |          | 设备端日志中的时间戳                     |
|                |         |          | 主机时间源。                             |
| IPCR           | 24 & 25 | AMSS     | AF_QIPCRTR 客户端和服务器。              |
DMA桥接器
概述
DMA桥接器是设备与主机通信的主要接口之一  
（另一个是MHI）。作为在NSP上激活工作负载运行的一部分，QSM  
为该网络分配一个DMA桥接通道。工作负载的DMA桥接通道  
（简称 DBC）仅用于该工作负载，且不与其他内容共享  
其他工作负载。

每个 DBC 是一对 FIFO，用于管理工作负载的数据输入和输出。其中一个  
FIFO 是请求 FIFO。另一个 FIFO 是响应 FIFO。
--------------------------------------------------------------------------------------------------------------

每个DBC在硬件中包含4个寄存器：  
* 请求FIFO头部指针（偏移量0x0）。仅由主机读取。指示  
FIFO 中设备已消耗的最新项。  
* 请求FIFO尾指针（偏移量0x4）。由主机读写  
递增此寄存器以向 FIFO 添加新项目。  
* 响应FIFO头指针（偏移量0x8）。由主机读写。指示  
FIFO 中主机已消费的最新项。  
* 响应FIFO尾指针（偏移量0xc）。仅由主机读取。设备  
递增此寄存器以向 FIFO 添加新项目。
每个寄存器中的值都是 FIFO 中的索引。要获取位置，需  
寄存器指向的FIFO元素：FIFO基地址 + 寄存器 * 元素  
大小。
DBC寄存器通过第二个BAR暴露给主机。每个DBC占用  
BAR中的4KB空间。
实际的FIFO由主机内存提供支持。当向QSM发送请求时  
要激活网络，主机必须分配内存用于FIFO。  
由于设备的内部映射限制，单个连续的数据块  
必须根据 DBC 为托管两个 FIFO 的设备提供内存。请求 FIFO 将  
占据该内存块的前半部分，响应FIFO将占据  
该内存块的后半部分。

主机需及时清空响应队列，并注意处理插入竞争问题。
------------------------------------------------

请求FIFO
一个请求FIFO元素具有以下结构：  
.. code-block:: c  
struct request_elem {  
\tu16 req_id;  
\tu8  seq_id;  
\tu8  pcie_dma_cmd;  
\tu32 reserved;  
\tu64 pcie_dma_source_addr;  
\tu64 pcie_dma_dest_addr;  
\tu32 pcie_dma_len;  
\tu32 reserved;  
\tu64 doorbell_addr;  
\tu8  doorbell_attr;  
\tu8  reserved;  
\tu16 reserved;  
\tu32 doorbell_data;  
\tu32 sem_cmd0;  
\tu32 sem_cmd1;  
\tu32 sem_cmd2;  
\tu32 sem_cmd3;  
};
请求字段说明：  
req_id  
请求ID。一个请求FIFO元素和一个响应FIFO元素  
相同的请求 ID 指向相同的命令。  
seq_id  
请求内的序列ID。DMA桥接器会忽略此字段。  
pcie_dma_cmd  
描述此请求的DMA元素。  
* Bit(7) 是强制 MSI 标志，用于覆盖 DMA 桥接 MSI 逻辑  
并在此请求完成时生成一个MSI，以及QSM  
配置DMA桥以查看此位。  
* Bits(6:5) 保留。  
* Bit(4) 是完成码标志，表示 DMA 桥接器  
当此请求发生时，应生成一个响应FIFO元素  
完成。  
* Bit(3) 表示此请求是链表传输（0）还是批量传输  
transfer(1)。  
* Bit(2) 保留。  
* Bits(1:0) 表示传输类型。无传输(0)，到设备(1)，  
来自设备(2)。值3是非法的。  
pcie_dma_source_addr  
批量传输的源地址，或链表的地址。  
pcie_dma_dest_addr  
批量传输的目标地址。  
pcie_dma_len  
批量传输的长度。请注意，此字段的大小  
限制传输大小为4G。  
doorbell_addr  
请求完成时需要按门铃的地址。  
doorbell_attr  
门铃属性。  
* Bit(7) 表示是否会发生对门铃寄存器的写入操作。  
* 第6到第2位是保留位。  
* Bits(1:0) 包含门铃长度的编码。0 表示 32 位，  
1 是 16 位，2 是 8 位，3 被保留。门铃地址  
必须自然地与指定长度对齐。  
doorbell_data  
要写入门铃的数据。仅对应于的位  
门铃长度有效。  
sem_cmdN  
信号量命令。  
* Bit(31) 表示此信号量命令已启用。  
* Bit(30) 是到设备的 DMA 信号量。阻塞此请求，直到所有  
到设备的 DMA 传输已完成。  
* Bit(29) 是来自设备的 DMA 信号量。请阻塞此请求，直到所有操作完成  
来自设备的DMA传输已完成。  
* Bits(28:27) 为保留位。  
* Bits(26:24) 是信号量命令。0 表示 NOP。1 表示进行初始化，  
指定的值。2 表示递增。3 表示递减。4 表示等待  
直到信号量等于指定的值。5 表示等待  
直到信号量大于或等于指定的值。  
6 是 "P"，等待信号量大于 0，然后  
减少1。7被保留。  
* 第23位是保留位。  
* Bit(22) 是信号量同步。0 表示发布后同步，这意味着  
信号量操作在DMA传输之后执行。1是  
presync，用于控制DMA传输的信号。只有一个presync  
每次请求允许的数量。  
* Bit(21) 是保留位。  
* Bits(20:16) 是要操作的信号量的索引。  
* 第15到12位是保留位。  
* Bits(11:0) 是操作中要使用的信号量值。
总体而言，一个请求的处理分为4个步骤：  
1. 如果指定了该条件，则预同步信号量必须为真  
2. 如果启用，将发生DMA传输  
3. 如果指定了，则同步后信号量条件必须为真  
4. 如果启用，门铃将被写入
通过将信号量与在NSP上运行的工作负载结合使用，  
数据管道可以同步，以便主机能够排队多个  
工作负载处理所需的数据请求，但DMA桥接器仅会复制  
当工作负载准备就绪进行处理时，将数据加载到其内存中  
下一个输入。
响应FIFO
一旦请求被完全处理，就会生成一个响应FIFO元素，如果  
在pcie_dma_cmd中指定。响应FIFO元素的结构：  
.. code-block:: c  
struct response_elem {  
\tu16 req_id;  
\tu16 completion_code;  
};  
req_id  
匹配生成此元素的请求的 req_id。  
completion_code  
此请求的状态。0 表示成功，非零表示错误。

DMA桥接器将根据主机中活动的反应生成MSI。  
DBC的响应FIFO。DMA桥硬件具有IRQ风暴缓解功能  
算法，仅当响应FIFO状态发生转换时才会生成MSI  
从空到非空（除非启用了强制MSI并被触发）。在  
响应此MSI时，主机需要清空响应FIFO，并且必须  
注意处理在清空FIFO时可能出现的任何竞争条件，以及  
设备将元素插入FIFO。
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

神经网络控制（NNC）协议
NNC协议是主机向QSM发送请求以管理工作负载的方式。  
它使用 QAIC_CONTROL MHI 通道。
每个NNC请求都被打包成一条带头部的事务序列消息。每条消息都是一系列  
transactions. 一种直通型交易可以包含称为  
命令。
QSM 要求 NNC 消息采用小端字节序编码，且字段需自然对齐  
对齐。由于某些NNC消息中包含64位元素，因此需要64位对齐  
必须予以维护。
一条消息包含一个头部，然后是一系列交易。消息可能为  
从 QSM 到主机的消息大小最多为 4K。从主机到 QSM 的消息  
最多可以是64K（单个MHI数据包的最大大小），但存在  
续传机制，其中第N+1条消息可被标记为前一条消息的延续  
message N。这用于极大的 DMA 传输事务。
交易描述  
passthrough  
允许用户空间将不透明的有效负载直接发送到QSM。  
用于NNC命令。用户空间负责管理  
有效载荷中QSM消息的要求。  
dma_xfer  
DMA传输。描述QSM应通过DMA传入的对象  
通过地址和大小元组来访问设备。  
activate  
将工作负载激活到NSPs上。主机必须提供内存以供使用。  
由DBC使用。  
deactivate  
停用一个活跃的工作负载，并将NSP返回到空闲状态。  
状态  
查询 QSM 关于其 NNC 实现的信息。返回 NNC 版本，  
以及是否使用了CRC。  
终止  
释放用户的资源。  
dma_xfer_cont  
之前DMA传输的延续。如果发生DMA传输  
不能在单条消息中指定（高度碎片化），此  
可以使用事务来指定更多的范围。  
validate_partition  
查询 QSM 以确定分区标识符是否有效。

每条消息都带有用户ID和分区ID。用户ID允许  
QSM 用于跟踪资源，并在用户离开时（例如进程结束时）释放这些资源  
崩溃）。分区ID用于标识QSM管理的资源分区，  
此消息适用的内容。
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------

消息可能包含CRC。在QSM之前，消息应应用CRC  
通过状态事务报告CRC不需要。QSM上的  
SA9000P 要求使用 CRC 进行黑通道安全保护。
子系统重启 (SSR)
SSR 是限制错误影响的概念。AIC100 设备可以  
有多个用户，每个用户都有各自独立运行的工作负载。如果工作负载的  
一个用户崩溃时，其影响应仅限于该工作负载，而不会  
影响其他工作负载。SSR 实现了这一点。
如果某个特定工作负载崩溃，QSM 会通过 QAIC_SSR MHI 通知主机  
channel。此通知通过分配的DBC来识别工作负载。一个  
多阶段恢复流程随后被用于清理双方，并使  
DBC/NSPs恢复至正常工作状态。
当 SSR 发生时，工作负载中的任何状态都会丢失。所有已输入的内容都将  
process，或已排队但尚未处理的，将丢失。已加载的构件将  
保留在卡上DDR中，但如果主机需要重新激活工作负载，则  
它希望恢复工作负载。

可靠性、可用性、可服务性（RAS）
===============================

AIC100 预计将部署在采用 RAS 理念的服务器系统中  
应用。简而言之，RAS 是指检测、分类和  
报告错误。虽然PCIe具有AER（高级错误报告），其会考虑  
进入RAS后，AER不允许设备报告有关内部的详细信息  
错误。因此，AIC100 实现了自定义的 RAS 机制。当发生 RAS 事件时  
发生时，QSM 将通过 QAIC_STATUS 报告事件及相关详细信息  
MHI 通道。系统管理员可能会确定某个特定设备需要  
基于RAS报告的附加服务。
遥测
QSM 能够报告设备的各种物理属性，并且在  
在某些情况下，允许主机对其进行控制。例如热限制，  
热读数和功率读数。这些项目通过以下方式传输：  
QAIC_TELEMETRY MHI 通道。
用于通用计算工作负载。

假设用户想要使用AIC100，他们将遵循以下步骤：

1. 将工作负载编译为针对 NSP 的 ELF 文件
2. 向QSM发送请求以将工作负载及相关工件加载到
设备 DDR
3. 向QSM发送请求，将工作负载激活到一组空闲的NSP上
4. 向DMA桥接器发送请求，将输入数据发送到工作负载以进行处理
已处理，以及其他请求从已处理的输出数据中接收数据的请求
工作负载。
5. 当工作负载不再需要时，向 QSM 发出请求以
停用工作负载，从而使NSP恢复到空闲状态。
6. 一旦工作负载及相关制品不再需要用于将来用途
会话，向QSM发送请求以从DDR卸载数据。这将释放
供其他用户使用的DDR。


启动流程
========

AIC100 采用无闪存启动流程，源自高通 MSM。

当AIC100首次上电时，它开始执行PBL（主引导加载程序）
来自ROM。PBL枚举PCIe链路，并初始化BHI（Boot Host
MHI的接口组件。

使用 BHI，主机将 PBL 指向 SBL（二级引导加载程序）的位置
image。PBL 从主机拉取镜像，验证其有效性，并开始
SBL的执行。

SBL 初始化 MHI，并使用 MHI 通知主机设备已进入
SBL 阶段。SBL 执行多项操作：

* SBL 初始化大部分硬件（PBL 未初始化的任何部分），
包括DDR。
* SBL 将启动日志卸载到主机。
* SBL 与主机同步时间戳，用于未来的日志记录。
* SBL 使用 Sahara 协议从运行时获取固件镜像
主机。

一旦SBL获取并验证了运行时固件，它就会启动NSP
复位，并跳转到QSM。

QSM 使用 MHI 通知主机设备已进入 QSM 阶段
（MHI术语中的AMSS）。此时，AIC100设备已完全具备功能，且
准备好处理工作负载。

用户空间组件
============

编译器
------

基于上游LLVM的AIC100开源编译器可以在以下位置找到：
https://github.com/quic/software-kit-for-qualcomm-cloud-ai-100-cc

用户模式驱动程序 (UMD)
----------------------

一个与 qaic 内核驱动程序交互的开源 UMD 可在以下位置找到：
https://github.com/quic/software-kit-for-qualcomm-cloud-ai-100

Sahara 加载器
-------------

一个名为 kickstart 的 Sahara 协议开源实现可以在以下位置找到：
https://github.com/andersson/qdl

MHI 频道
========

AIC100 定义了多种用于不同目的的 MHI 通道。以下是列表
已定义的通道及其用途。

+----------------+---------+----------+----------------------------------------+
| 频道名称       | IDs     | EEs      | 用途                                     |
+================+=========+==========+========================================+
| QAIC_LOOPBACK  | 0 & 1   | AMSS     | 发送到该设备的任何数据    |
|                |         |          | 通道被发送回主机。      |
+----------------+---------+----------+----------------------------------------+
| QAIC_SAHARA    | 2 & 3   | SBL      | SBL 用于获取运行时的值      |
|                |         |          | 从主机获取固件。                |
+----------------+---------+----------+----------------------------------------+
| QAIC_DIAG      | 4 & 5   | AMSS     | 用于通过 QSM 进行通信的   |
|                |         |          | DIAG 协议。                         |
+----------------+---------+----------+----------------------------------------+
| QAIC_SSR       | 6 & 7   | AMSS     | 用于通知主机子系统状态   |
|                |         |          | 重启事件，并卸载SSR     |
|                |         |          | crashdumps.                            |
+----------------+---------+----------+----------------------------------------+
| QAIC_QDSS      | 8 和 9   | AMSS     | 用于高通调试子系统。 |
+----------------+---------+----------+----------------------------------------+
| QAIC_CONTROL   | 10 & 11 | AMSS     | 用于神经网络控制    |
|                |         |          | (NNC) 协议。这是主要的    |
|                |         |          | 主机与QSM之间的通道用于       |
|                |         |          | 管理工作负载。                    |
+----------------+---------+----------+----------------------------------------+
| QAIC_LOGGING   | 12 & 13 | SBL      | SBL 用于将启动日志发送到 |
|                |         |          | 主机。                              |
+----------------+---------+----------+----------------------------------------+
| QAIC_STATUS    | 14 & 15 | AMSS     | 用于向主机通知可靠性，|
|                |         |          | 可访问性、可服务性 (RAS)    |
|                |         |          | events.                                |
+----------------+---------+----------+----------------------------------------+
| QAIC_TELEMETRY | 16 和 17 | AMSS     | 用于获取/设置电源、温度等信息      |
|                |         |          | attributes.                            |
+----------------+---------+----------+----------------------------------------+
| QAIC_DEBUG     | 18 & 19 | AMSS     | 未使用。                              |
+----------------+---------+----------+----------------------------------------+
| QAIC_TIMESYNC  | 20 & 21 | SBL      | 用于同步时间戳 |
|                |         |          | 设备端日志与主机时间    |
|                |         |          | source.                                |
+----------------+---------+----------+----------------------------------------+
| QAIC_TIMESYNC  | 22 & 23 | AMSS     | 用于周期性同步       |
| _PERIODIC      |         |          | 设备端日志中的时间戳 |
|                |         |          | 主机时间源。                  |
+----------------+---------+----------+----------------------------------------+
| IPCR           | 24 & 25 | AMSS     | AF_QIPCRTR 客户端和服务器。        |
+----------------+---------+----------+----------------------------------------+

DMA桥接器
=========

概述
----

DMA桥接器是设备与主机通信的主要接口之一
（另一个是MHI）。作为在NSP上激活工作负载运行的一部分，QSM
为该网络分配一个DMA桥接通道。工作负载的DMA桥接通道
（简称 DBC）仅用于该工作负载，且不与其他内容共享
其他工作负载。

每个 DBC 是一对 FIFO，用于管理工作负载的数据输入和输出。其中一个
FIFO 是请求 FIFO。另一个 FIFO 是响应 FIFO。

每个DBC在硬件中包含4个寄存器：

* 请求FIFO头部指针（偏移量0x0）。仅由主机读取。指示
FIFO 中设备已消耗的最新项。
* 请求FIFO尾指针（偏移量0x4）。由主机读写
递增此寄存器以向 FIFO 添加新项目。
* 响应FIFO头指针（偏移量0x8）。由主机读写。指示
FIFO 中主机已消费的最新项。
* 响应FIFO尾指针（偏移量0xc）。仅由主机读取。设备
递增此寄存器以向 FIFO 添加新项目。

每个寄存器中的值都是 FIFO 中的索引。要获取位置，需
寄存器指向的FIFO元素：FIFO基地址 + 寄存器 * 元素
大小。

DBC寄存器通过第二个BAR暴露给主机。每个DBC占用
BAR中的4KB空间。

实际的FIFO由主机内存提供支持。当向QSM发送请求时
要激活网络，主机必须分配内存用于FIFO。
由于设备的内部映射限制，单个连续的数据块
必须根据 DBC 为托管两个 FIFO 的设备提供内存。请求 FIFO 将
消耗内存块的起始部分，响应FIFO将进行消费
内存块的末尾。

请求FIFO
--------

一个请求FIFO元素具有以下结构：

.. code-block:: c

struct request_elem {
u16 req_id;
\tu8  seq_id;
u8  pcie_dma_cmd;
u32 reserved;
u64 pcie_dma_source_addr;
u64 pcie_dma_dest_addr;
u32 pcie_dma_len;
u32 reserved;
u64 doorbell_addr;
u8  doorbell_attr;
u8  reserved;
u16 reserved;
u32 doorbell_data;
u32 sem_cmd0;
u32 sem_cmd1;
u32 sem_cmd2;
u32 sem_cmd3;
};

请求字段说明：

req_id
请求ID。一个请求FIFO元素和一个响应FIFO元素
相同的请求 ID 指向相同的命令。

seq_id
请求内的序列ID。DMA桥接器会忽略此字段。

pcie_dma_cmd
描述此请求的DMA元素。

* Bit(7) 是强制 MSI 标志，用于覆盖 DMA 桥接 MSI 逻辑
并在此请求完成时生成一个MSI，以及QSM
配置DMA桥以查看此位。
* Bits(6:5) 保留。
* Bit(4) 是完成码标志，表示 DMA 桥接器
当此请求发生时，应生成一个响应FIFO元素
完成。
* Bit(3) 表示此请求是链表传输（0）还是批量传输
transfer(1)。
* Bit(2) 保留。
* Bits(1:0) 表示传输类型。无传输(0)，到设备(1)，
来自设备(2)。值3是非法的。

pcie_dma_source_addr
批量传输的源地址，或链表的地址。

pcie_dma_dest_addr
批量传输的目标地址。

pcie_dma_len
批量传输的长度。请注意，此字段的大小
限制传输大小为4G。

doorbell_addr
请求完成时需要按门铃的地址。

doorbell_attr
门铃属性。

* Bit(7) 表示是否会发生对门铃寄存器的写入操作。
* 第6到第2位是保留位。
* Bits(1:0) 包含门铃长度的编码。0 表示 32 位，
1 是 16 位，2 是 8 位，3 被保留。门铃地址
必须自然地与指定长度对齐。

doorbell_data
要写入门铃的数据。仅对应于的位
门铃长度有效。

sem_cmdN
信号量命令。

* Bit(31) 表示此信号量命令已启用。
* Bit(30) 是到设备的 DMA 信号量。阻塞此请求，直到所有
到设备的 DMA 传输已完成。
* Bit(29) 是来自设备的 DMA 信号量。请阻塞此请求，直到所有操作完成
来自设备的DMA传输已完成。
* Bits(28:27) 为保留位。
* Bits(26:24) 是信号量命令。0 表示 NOP。1 表示进行初始化，
指定的值。2 表示递增。3 表示递减。4 表示等待
直到信号量等于指定的值。5 表示等待
直到信号量大于或等于指定的值。
6 是 "P"，等待信号量大于 0，然后
减少1。7被保留。
* 第23位是保留位。
* Bit(22) 是信号量同步。0 表示发布后同步，这意味着
信号量操作在DMA传输之后执行。1是
presync，用于控制DMA传输的信号。只有一个presync
每次请求允许的数量。
* Bit(21) 是保留位。
* Bits(20:16) 是要操作的信号量的索引。
* 第15到12位是保留位。
* Bits(11:0) 是操作中要使用的信号量值。

总体而言，一个请求的处理分为4个步骤：

1. 如果指定了该条件，则预同步信号量必须为真
2. 如果启用，将发生DMA传输
3. 如果指定了，则同步后信号量条件必须为真
4. 如果启用，门铃将被写入

通过将信号量与在NSP上运行的工作负载结合使用，
数据管道可以同步，以便主机能够排队多个
工作负载处理所需的数据请求，但DMA桥接器仅会复制
当工作负载准备就绪进行处理时，将数据加载到其内存中
下一个输入。

响应FIFO
--------

一旦请求被完全处理，就会生成一个响应FIFO元素，如果
在pcie_dma_cmd中指定。响应FIFO元素的结构：

.. code-block:: c

struct response_elem {
u16 req_id;
u16 completion_code;
};

req_id
匹配生成此元素的请求的 req_id。

completion_code

翻译结果：
此请求的状态。0 表示成功，非零表示错误。

DMA桥接器将根据主机中活动的反应生成MSI。
DBC的响应FIFO。DMA桥硬件具有IRQ风暴缓解功能
算法，仅当响应FIFO状态发生转换时才会生成MSI
从空到非空（除非启用了强制MSI并被触发）。在
响应此MSI时，主机需要清空响应FIFO，并且必须
注意处理在清空FIFO时可能出现的任何竞争条件，以及
设备将元素插入FIFO。

神经网络控制（NNC）协议
=======================

NNC协议是主机向QSM发送请求以管理工作负载的方式。
它使用 QAIC_CONTROL MHI 通道。

每个NNC请求都被打包成一条消息。每条消息都是一系列
transactions. 一种直通型交易可以包含称为
命令。

QSM 要求 NNC 消息采用小端字节序编码，且字段需自然对齐
对齐。由于某些NNC消息中包含64位元素，因此需要64位对齐
必须予以维护。

一条消息包含一个头部，然后是一系列交易。消息可能为
从 QSM 到主机的消息大小最多为 4K。从主机到 QSM 的消息
最多可以是64K（单个MHI数据包的最大大小），但存在
延续功能，其中第N+1条消息可被标记为前一条消息的延续
message N。这用于极大的 DMA 传输事务。

交易描述
--------

passthrough
允许用户空间将不透明的有效负载直接发送到QSM。
用于NNC命令。用户空间负责管理
有效载荷中QSM消息的要求。

dma_xfer
DMA传输。描述QSM应通过DMA传入的对象
通过地址和大小元组来访问设备。

激活
将工作负载激活到NSPs上。主机必须提供内存以供使用。
由DBC使用。

deactivate
停用一个活跃的工作负载，并将NSP返回到空闲状态。

状态
查询 QSM 关于其 NNC 实现的信息。返回 NNC 版本，
以及是否使用了CRC。

终止
释放用户的资源。

dma_xfer_cont
之前DMA传输的延续。如果发生DMA传输
不能在单条消息中指定（高度碎片化），此
可以使用事务来指定更多的范围。

validate_partition
查询 QSM 以确定分区标识符是否有效。

每条消息都带有用户ID和分区ID。用户ID允许
QSM 用于跟踪资源，并在用户离开时（例如进程结束时）释放这些资源
崩溃）。分区ID用于标识QSM管理的资源分区，
此消息适用的内容。

消息可能包含CRC。在QSM之前，消息应应用CRC
通过状态事务报告CRC不需要。QSM上的
SA9000P 要求使用 CRC 进行黑通道安全保护。

子系统重启 (SSR)
================

SSR 是限制错误影响的概念。AIC100 设备可以
有多个用户，每个用户都有各自独立运行的工作负载。如果工作负载的
一个用户崩溃时，其影响应仅限于该工作负载，而不会
影响其他工作负载。SSR 实现了这一点。

如果某个特定工作负载崩溃，QSM 会通过 QAIC_SSR MHI 通知主机
channel。此通知通过分配的DBC来识别工作负载。A
然后采用多阶段恢复过程来清理双方，并使
将DBC/NSPs转换为工作状态。

当 SSR 发生时，工作负载中的任何状态都会丢失。所有已输入的内容都将
process，或已排队但尚未处理的，将丢失。已加载的构件将
保留在卡上DDR中，但如果主机需要重新激活工作负载，则
它希望恢复工作负载。

可靠性、可用性、可服务性（RAS）
===============================

AIC100 预计将部署在采用 RAS 理念的服务器系统中
应用。简而言之，RAS 是指检测、分类和
报告错误。虽然PCIe具有AER（高级错误报告），其会考虑
进入RAS后，AER不允许设备报告有关内部的详细信息
错误。因此，AIC100 实现了自定义的 RAS 机制。当发生 RAS 事件时
发生时，QSM 将通过 QAIC_STATUS 报告事件及相关详细信息
MHI 通道。系统管理员可能会确定某个特定设备需要
基于RAS报告的附加服务。

遥测
====

QSM 能够报告设备的各种物理属性，并且在
在某些情况下，允许主机对其进行控制。例如热限制，
热读数和功率读数。这些项目通过以下方式传输：
QAIC_TELEMETRY MHI 通道。


==================================================

由 Qwen-plus 及 LT agent 翻译