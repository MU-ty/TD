.. SPDX-License-Identifier: GPL-2.0


引言
====

Linux计算加速器子系统旨在提供计算能力的暴露
加速器以一种通用的方式向用户空间提供，并给出一组通用的
功能。

这些设备可以是独立的ASIC，也可以是SoC/GPU内部的IP模块。
尽管这些设备通常旨在加速
机器学习（ML）和/或深度学习（DL）计算，加速层
不仅限于处理这些类型的加速器。

通常，计算加速器将属于以下类别之一
categories:

- 边缘AI - 在边缘设备上进行推理。它可以是嵌入式ASIC/FPGA，
或SoC内部的IP（例如笔记本电脑网络摄像头）。这些设备
通常通过寄存器进行配置，可以配合 DMA 使用，也可以不使用 DMA。

- 推理数据中心 - 大型服务器中的单用户/多用户设备。这
设备类型可以是独立的，也可以是SoC或GPU内部的IP。
具有板载DRAM（用于存储深度学习拓扑结构）、DMA引擎和
命令提交队列（内核队列或用户空间队列）。
它可能还配备有MMU以管理多个用户，并可能实现
虚拟化（SR-IOV）以在同一设备上支持多个虚拟机。
此外，这些设备通常会配备一些工具，例如性能分析器和
调试器。

- 训练数据中心 - 与推理数据中心卡类似，但通常
拥有更强的计算能力和内存带宽（例如 HBM），并且可能具备
一种扩展/横向扩展的方法，即连接到其他内部训练卡
服务器或其他服务器中。

这些设备通常具有不同的运行时用户空间软件堆栈，
根据其硬件定制的。此外，它们可能还
包含一个编译器，用于生成程序以运行于他们定制的计算设备上
引擎。通常，用户空间中的公共层将是深度学习框架，
例如 PyTorch 和 TensorFlow。

使用DRM共享代码
===============

因为这类设备可以是GPU内部的IP，或者具有类似特性
特性与GPU相同，加速子系统将使用
DRM子系统的代码和功能。即，加速核心代码将
属于DRM子系统，而加速设备将是DRM的一种新类型
设备。

这将使我们能够利用广泛的DRM代码库
与具有此类经验的DRM开发者合作
设备。此外，将为加速器添加的新功能
驱动程序对GPU驱动程序也同样有用，实现技术反哺。

与GPU的区别
===========

因为我们希望防止庞大的用户空间图形软件栈
在尝试将加速器用作GPU时，计算加速器将会
通过使用新的主设备号和新的设备字符文件，与GPU区分开来。

此外，驱动程序将位于内核中的一个独立位置
tree - drivers/accel/.

加速器设备将通过专用方式暴露给用户空间
261 主设备号，并遵循以下约定：

- 设备字符文件 - /dev/accel/accel\\*
- sysfs             - /sys/class/accel/accel\\*/
- debugfs           - /sys/kernel/debug/accel/\*/

入门指南
========

首先，阅读 Documentation/gpu/index.rst 中的 DRM 文档，包括贡献流程、行为准则和编码规范。
它不仅会解释如何编写一个新的DRM驱动程序，而且还会
包含有关如何贡献、行为准则以及所有相关信息
编码风格/文档规范是什么。这些对于以下内容都是相同的：
accel 子系统。

其次，确保内核已配置 CONFIG_DRM_ACCEL。

要将设备作为加速器暴露，需要进行以下两项更改：
在你的驱动程序中完成（而非标准的DRM驱动程序）：

- 在您的 drm_driver 中添加 DRIVER_COMPUTE_ACCEL 功能标志
driver_features 字段。需要注意的是，此驱动程序功能是
与 DRIVER_RENDER 和 DRIVER_MODESET 互斥。希望
应同时暴露图形和计算设备，字符文件应被处理
使用辅助总线框架连接的两个驱动程序。

- 将驱动程序 fops 结构中的 open 回调更改为 accel_open()。
或者，您的驱动程序可以使用 DEFINE_DRM_ACCEL_FOPS 宏来轻松实现
设置正确的函数操作指针结构。

外部参考文献
============

邮件往来
--------

* `初始讨论与补丁集发布：加速设备新子系统的设计 <https://lore.kernel.org/lkml/CAFCwf11=9qpNAepL7NL+YAV_QO=Wv6pnWPhKHKAepK3fNn+2Dg@mail.gmail.com/>`_ - Oded Gabbay (2022)
* `补丁集发布：添加新子系统 <https://lore.kernel.org/lkml/20221022214622.18042-1-ogabbay@kernel.org/>`_ - Oded Gabbay (2022)

会议演讲
--------

* `LPC 2022 加速器 BOF 成果摘要 <https://airlied.blogspot.com/2022/09/accelerators-bof-outcomes-summary.html>`_ - Dave Airlie (2022)


==================================================

由 Qwen-plus 及 LT agent 翻译