.. SPDX-License-Identifier: GPL-2.0
.. include:: <isonum.txt>


PCI Express 高级错误报告驱动程序指南 HOWTO
==========================================

:作者: - T. Long Nguyen <tom.l.nguyen@intel.com>（本文档由 Intel 公司开发）
- Yanmin Zhang <yanmin.zhang@intel.com>（Intel 公司）

:版权: |copy| 2006 Intel Corporation

概述
====

关于本指南
----------

本指南介绍了PCI Express（PCIe）高级错误的基础知识
报告（AER）驱动程序并提供有关如何使用它的信息，以及
以及如何启用终端设备的驱动程序以符合
PCIe AER 驱动程序。


什么是PCIe AER驱动程序？
------------------------

PCIe 错误信号可能在 PCIe 链路本身上发生
或代表在该链接上发起的交易。PCIe
定义了两种错误报告范式：基准能力和
高级错误报告功能。该基础功能为
所有提供最低定义的PCIe组件均需满足
一组错误报告要求。高级错误报告
该功能通过PCIe高级错误报告实现
提供更强大错误报告功能的扩展能力结构。

PCIe AER 驱动程序提供了支持 PCIe 高级功能的基础设施
错误报告功能。PCIe AER 驱动程序提供三种基本功能
functions:

- 如果发生错误，则收集完整的错误信息。
- 向用户报告错误。
- 执行错误恢复操作。

AER驱动程序仅附加到支持PCIe的根端口和RCEC
AER 功能。


用户指南
========

将PCIe AER根驱动程序包含到Linux内核中
-------------------------------------

PCIe AER 驱动程序是一个附加的根端口服务驱动程序
通过PCIe端口总线驱动程序。如果用户想要使用它，该驱动程序
必须进行编译。通过 CONFIG_PCIEAER 启用该功能，
取决于 CONFIG_PCIEPORTBUS。

加载PCIe AER根驱动程序
----------------------

某些系统在固件中支持AER。在Linux中启用AER支持时
同一时间，固件处理AER将导致不可预测的结果
行为。因此，除非固件支持，否则 Linux 不会处理 AER 事件
通过 ACPI _OSC 方法将 AER 控制权授予操作系统。参见 PCI 固件
有关 _OSC 使用的详细规范。

AER 错误输出
------------

当捕获到PCIe AER错误时，将输出一条错误消息到
控制台。如果是可纠正的错误，则会以警告消息的形式输出。
否则，它将作为错误打印出来。因此用户可以选择不同的
用于过滤可纠正错误消息的日志级别。

如下所示为一个示例::

0000:50:00.0：PCIe 总线错误：严重性=不可纠正（致命），类型=事务层，（请求者 ID，表示发送错误消息的设备 ID；其余字段定义详见 PCIe 规范）
0000:50:00.0：设备 [8086:0329] 错误状态/掩码=00100000/00000000
0000:50:00.0:    [20] 不支持的请求               (首次)
0000:50:00.0：   TLP 头部：0x04000001 0x00200a03 0x05010000 0x00050100

在示例中，“Requester ID”表示发送请求的设备的ID
向根端口发送错误消息。有关其他信息，请参考PCIe规范
字段。

AER 速率限制
------------

由于每笔交易都可能生成错误消息，我们可能会看到
报告了大量错误。为防止垃圾设备泛滥
控制台/执行暂停，消息因设备和错误而受到限制
类型（可纠正与非致命性不可纠正）。致命性错误，包括
DPC错误未进行速率限制。

AER 使用默认的速率限制 DEFAULT_RATELIMIT_BURST（10 个事件）
DEFAULT_RATELIMIT_INTERVAL（5 秒）。

速率限制以 sysfs 属性的形式暴露，并且可配置，对应宏定义为 DEFAULT_RATELIMIT_INTERVAL 和 DEFAULT_RATELIMIT_BURST。
参见 Documentation/ABI/testing/sysfs-bus-pci-devices-aer。

AER 统计信息 / 计数器
---------------------

当捕获到PCIe AER错误时，计数器/统计信息也会被暴露出来
以 sysfs 属性的形式呈现，相关文档位于
Documentation/ABI/testing/sysfs-bus-pci-devices-aer。

开发者指南
==========

要启用错误恢复，软件驱动程序必须提供回调函数。

为了更好地支持AER，开发人员需要了解AER的工作原理。

PCIe 错误分为两种类型：可纠正错误
以及不可纠正的错误。此分类基于其影响
这些错误可能导致性能下降或功能异常
失败。

可纠正的错误不会对功能产生影响
接口。PCIe协议可以在无需任何软件的情况下恢复
干预或任何数据丢失。这些错误将被检测并
由硬件校正。

与可纠正错误不同，不可纠正
错误会影响界面的功能。无法纠正的错误
可能导致特定事务或特定PCIe链路
不可靠。根据这些错误情况，无法纠正
错误进一步分为非致命错误和致命错误。
非致命性错误会导致特定事务不可靠，
但PCIe链路本身完全正常。致命错误，关于
另一方面，会导致链接不可靠。

当启用PCIe错误报告时，设备将自动发送一个
当它捕获时，向上层的根端口发送错误消息
一个错误。根端口在接收到错误报告消息后，
在内部处理错误消息并将其记录到AER中
功能结构。记录的错误信息包括存储
将错误报告代理的请求者ID填入错误源
识别寄存器及设置根错误的错误位
相应地更新状态寄存器。如果在根端口启用了AER错误报告
错误命令寄存器，当根端口生成中断时
检测到错误。

请注意，上述描述的错误与PCIe相关
层级和链接。这些错误不包括任何设备特定的
错误，因为设备特定的错误仍会直接发送到
设备驱动程序。

提供回调函数
------------

PCI 错误恢复回调函数
~~~~~~~~~~~~~~~~~~~~

PCIe AER Root 驱动程序使用错误回调来协调
与相关层次结构中的下游设备驱动程序
执行错误恢复操作时。

数据结构 pci_driver 有一个指向 err_handler 的指针，
pci_error_handlers，由几个回调函数组成
指针。AER 驱动程序遵循定义的规则
pci-error-recovery.rst 除了 PCIe 特定部分（参见
如下所示。请参考 pci-error-recovery.rst 以获取详细信息
回调函数的定义。

以下各节指定了何时调用错误回调函数。

可纠正的错误
~~~~~~~~~~~~

可纠正的错误不会对功能产生影响
接口。PCIe协议可以在没有任何
软件干预或任何数据丢失。这些错误不会
无需执行任何恢复操作。AER驱动程序会清除设备的
相应地设置可纠正错误状态寄存器并记录这些错误。

无法纠正的（非致命和致命）错误
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

AER驱动程序执行次级总线复位以从中恢复
无法纠正的错误。重置应用于上方端口
发起设备：如果发起设备是一个终端节点，
仅端点被重置。而如果源自
设备有从属设备，这些设备都会受到影响
重置也会一并进行。

如果源设备是根复合体集成端点，
上方没有可应用次总线复位的端口。
在这种情况下，AER驱动程序会改为应用功能级别重置。

如果错误消息指示为非致命错误，请执行重置操作
在上游不是必需的。AER 驱动程序调用 error_detected(dev,
pci_channel_io_normal）到层次结构中关联的所有驱动程序
问题。例如：

端点 <==> 下游端口 B <==> 上游端口 A <==> 根端口

如果上游端口A捕获到一个AER错误，则该层级结构包括
下游端口 B 和终端设备。

驱动程序可能会返回 PCI_ERS_RESULT_CAN_RECOVER，
PCI_ERS_RESULT_DISCONNECT 或 PCI_ERS_RESULT_NEED_RESET，具体取决于
它是否能在不重置的情况下恢复，若不能则认为设备无法恢复
或者需要重置以恢复。如果所有受影响的驱动程序均同意可以
无需重置即可恢复的情况下，将跳过。若有一个驱动程序请求重置，
它会覆盖所有其他驱动程序。

如果错误消息指示出现严重错误，内核将广播
error_detected(dev, pci_channel_io_frozen) 发送给所有驱动程序
一个有争议的层级结构。然后，在上游执行重置操作
必要时。如果 error_detected 返回 PCI_ERS_RESULT_CAN_RECOVER
表示在不重置的情况下仍有可能恢复，错误
处理会转到 mmio_enabled，但之后仍然需要重置
已执行。

换句话说，对于非致命错误，驱动程序可以选择进行重置。
但对于致命错误，他们无法选择退出重置，基于以下原因：
假设该链接不可靠。

常见问题
--------

Q:

翻译结果：
如果PCIe设备驱动程序未提供
错误恢复处理程序（pci_driver->err_handler 是否等于 NULL）？

A:
使用该驱动程序连接的设备将无法恢复。
内核将打印出信息性消息以进行识别
无法恢复的设备。


软件错误注入
============

调试PCIe AER错误恢复代码非常困难，因为
很难触发真实的硬件错误。基于软件的错误
注入可用于模拟各种PCIe错误。

首先，您应在内核中启用PCIe AER软件错误注入
配置，也就是说，以下项目应包含在你的 .config 中。

CONFIG_PCIEAER_INJECT=y 或 CONFIG_PCIEAER_INJECT=m

重启后使用新内核或插入模块时，会生成一个名为
/dev/aer_inject 应该被创建。

然后，你需要一个名为 aer-inject 的用户空间工具，可以通过以下方式获取
from:

翻译结果：

https://github.com/intel/aer-inject.git

有关 aer-inject 的更多信息可以在以下文档中找到：
其源代码。


==================================================

由 Qwen-plus 及 LT agent 翻译